#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ pytest –¥–ª—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞

# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π python3
PYTHON="/usr/bin/python3"

echo "üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ pytest –¥–ª—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–æ–ø—Ü–∏–∏]"
    echo ""
    echo "–û–ø—Ü–∏–∏:"
    echo "  --api        –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç—ã –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (–ø–∞–ø–∫–∞ api)"
    echo "  -m smoke     –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ smoke —Ç–µ—Å—Ç—ã"
    echo "  -m critical  –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —Ç–µ—Å—Ç—ã"
    echo "  -v           –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥"
    echo "  --allure     –°–æ–∑–¥–∞—Ç—å Allure –æ—Ç—á–µ—Ç"
    echo "  --help       –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
    echo ""
    echo "–ü—Ä–∏–º–µ—Ä—ã:"
    echo "  $0                    # –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã"
    echo "  $0 --api              # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç—ã –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞"
    echo "  $0 --api -m smoke     # –ó–∞–ø—É—Å—Ç–∏—Ç—å smoke —Ç–µ—Å—Ç—ã –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞"
    echo "  $0 -v --allure        # –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥ —Å Allure –æ—Ç—á–µ—Ç–æ–º"
    echo "  $0 -m critical        # –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã"
    exit 0
fi

# –°–æ–±–∏—Ä–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
ARGS=""
ALLURE=false
API_ONLY=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --allure)
            ALLURE=true
            shift
            ;;
        --api)
            API_ONLY=true
            shift
            ;;
        *)
            ARGS="$ARGS $1"
            shift
            ;;
    esac
done

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ —Ç–µ—Å—Ç–∞–º
if [ "$API_ONLY" = true ]; then
    TEST_PATH="tests/api/"
    echo "üéØ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç—ã –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (API)..."
else
    TEST_PATH="tests/"
    echo "üéØ –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Ç–µ—Å—Ç—ã..."
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
echo "–í—ã–ø–æ–ª–Ω—è–µ–º: $PYTHON -m pytest $TEST_PATH$ARGS"
$PYTHON -m pytest $TEST_PATH $ARGS

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
if [ $? -eq 0 ]; then
    echo "‚úÖ –¢–µ—Å—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
    
    # –°–æ–∑–¥–∞–µ–º Allure –æ—Ç—á–µ—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if [ "$ALLURE" = true ]; then
        echo "üìä –°–æ–∑–¥–∞–µ–º Allure –æ—Ç—á–µ—Ç..."
        if command -v allure &> /dev/null; then
            allure generate allure-results -o allure-report --clean
            echo "üåê –û—Ç–∫—Ä—ã–≤–∞–µ–º Allure –æ—Ç—á–µ—Ç..."
            allure open allure-report
        else
            echo "‚ö†Ô∏è  Allure –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: sudo pacman -S allure"
        fi
    fi
else
    echo "‚ùå –¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –æ—à–∏–±–∫–∞–º–∏"
    exit 1
fi
